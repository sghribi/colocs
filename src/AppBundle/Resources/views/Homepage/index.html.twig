{% extends 'AppBundle::base.html.twig' %}

{% block body %}
  {# Autocomplete input#}
  <input id="map-input" class="controls" type="text" placeholder="Saisissez l'adresse ou le nom du lieu souhaitÃ©" />

  {# Map #}
  <div id="map"></div>

  {# Photo #}
  <img alt="{{ app.user.username }}"  src="data:image/jpg;base64,{{ app.user.photo }}" class="profile" />

  {# Singaler #}
  <button class="btn btn-info"><i class="fa fa-fw fa-plus-sign"></i> </button>

  {# Init map #}
  <script type="text/javascript">
    var map;
    var houses;

    function addMarkers (houses) {
      $.each(houses, function (index, house) {
        template =  Handlebars.compile($('#house-card').html());
        content =  template({house: house});

        var infowindow = new google.maps.InfoWindow({
          content: content
        });

        var marker = new google.maps.Marker({
          position: {lat: house.latitude, lng: house.longitude},
          map: map,
          icon: 'http://icons.iconarchive.com/icons/icons-land/vista-map-markers/48/Map-Marker-Ball-Azure-icon.png'
        });

        marker.addListener('click', function() {
          infowindow.open(map, marker);
        });
      });
    }


    function initMap() {
      map = new google.maps.Map(document.getElementById('map'), {
        center: {lat: 48.765165, lng:  2.288402},
        zoom: 14,
        mapTypeControlOptions: {
          style: google.maps.MapTypeControlStyle.HORIZONTAL_BAR,
          position: google.maps.ControlPosition.TOP_CENTER
        },
        panControl: false,
        zoomControl: true,
        zoomControlOptions: {
          position: google.maps.ControlPosition.LEFT_CENTER
        },
        mapTypeControl: false,
        scaleControl: true,
        streetViewControl: true,
        overviewMapControl: true
      });

      // ECP
      var ecpMarker = new google.maps.Marker({
        map: map,
        anchorPoint: new google.maps.Point(0, -29),
        icon: 'https://icons.iconarchive.com/icons/icons-land/vista-map-markers/48/Map-Marker-Ball-Pink-icon.png',
        position: {lat: 48.765165, lng:  2.288402}
      });

      // Add autocomplete
      var input = document.getElementById('map-input');
      var autocomplete = new google.maps.places.Autocomplete(input);
      autocomplete.bindTo('bounds', map);

      autocomplete.addListener('place_changed', function() {
        var place = autocomplete.getPlace();
        if (!place.geometry) {
          return;
        }

        if (place.geometry.viewport) {
          map.fitBounds(place.geometry.viewport);
        } else {
          map.setCenter(place.geometry.location);
          map.setZoom(17);
        }
      });


      $.ajax({
        url: Routing.generate('app_homepage_gethouses'),
        type: 'GET',
        success: function(data) {
          addMarkers(data);
        }
      });
    }

  </script>
  <script async defer src="https://maps.googleapis.com/maps/api/js?callback=initMap&libraries=places"></script>

  {% verbatim %}
    <script id="house-card" type="text/x-handlebars-template">
      <div class="house-card">
        <h4>{{ house.name }}</h4>
        <p><i class="fa fa-fw fa-map-marker"></i> {{ house.address }}</p>
        <em>{{ house.summary }}</em>
        {{#each house.members}}
        <div class="media">
          <div class="media-left media-middle">
            <a href="https://my.ecp.fr/m/{{ cti_uid }}" target="_blank">
              <img class="media-object" src="data:image/jpg;base64,{{ photo }}" alt="{{ username }}">
            </a>
          </div>
          <div class="media-body">
            {{ first_name }} {{ last_name }}
          </div>
        </div>
        {{/each}}
      </div>
    </script>
  {% endverbatim %}
{% endblock %}
